<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='概览 在 UE5 推出了服务于大世界的 World Partition 系统，总的来说主要分几大块： Grid、Level（Grid Level，非 ULevel）、Cell 的划分 OFPA Level Instance'><title>WorldPartition解析</title>
<link rel=canonical href=https://hebohang.github.io/p/worldpartition%E8%A7%A3%E6%9E%90/><link rel=stylesheet href=/scss/style.min.ced2f353a57d6289cd6f8ba44e33b0986a72c3bc872b125fc971b99a1b7dfca0.css><meta property='og:title' content='WorldPartition解析'><meta property='og:description' content='概览 在 UE5 推出了服务于大世界的 World Partition 系统，总的来说主要分几大块： Grid、Level（Grid Level，非 ULevel）、Cell 的划分 OFPA Level Instance'><meta property='og:url' content='https://hebohang.github.io/p/worldpartition%E8%A7%A3%E6%9E%90/'><meta property='og:site_name' content='何律师'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='UE5'><meta property='article:tag' content='UE5-WorldPartition'><meta property='article:published_time' content='2024-02-08T14:39:49+08:00'><meta property='article:modified_time' content='2024-02-08T14:39:49+08:00'><meta name=twitter:title content="WorldPartition解析"><meta name=twitter:description content="概览 在 UE5 推出了服务于大世界的 World Partition 系统，总的来说主要分几大块： Grid、Level（Grid Level，非 ULevel）、Cell 的划分 OFPA Level Instance"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huc6eca969b6e90a2ca3e53e7072c2603a_242990_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>何律师</a></h1><h2 class=site-description>游戏引擎研发</h2></div></header><ol class=social-menu><li><a href=https://github.com/hebohang target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://space.bilibili.com/62062585 target=_blank title=Bilibili rel=me><svg height="1153" viewBox="-.64 -4.64 2187.5 1004.88" width="2500" xmlns="http://www.w3.org/2000/svg"><path d="m2030.61 892.82c-9.77.0-18.55.0-26.37-.98-16.6-.97-33.2-1.95-49.8-1.95-10.74.0-10.74.0-11.72-10.74l-15.63-177.74-15.62-147.46-10.74-90.82-9.77-79.1-17.58-123.05c-5.86-43.94-12.69-86.91-21.48-130.86-.98-6.83-.98-7.81 6.84-8.79 30.27-5.86 61.52-8.79 92.77-8.79h10.74c4.88.98 7.81 3.91 8.79 9.77l3.91 67.38 27.34 364.26 13.67 166.99 8.79 95.71zM833.34 112.54h17.58c8.79.0 10.74 2.93 10.74 11.72l7.82 118.17 17.58 245.11 10.74 127.93 7.81 98.64 15.63 169.92c0 7.81-.98 8.79-8.79 8.79l-70.32-2.93c-4.88.98-7.81-1.95-7.81-6.84l-2.93-34.18c-2.93-29.29-5.86-58.59-7.81-88.86l-15.63-154.3-16.6-139.65-11.72-98.63-12.69-89.85c-5.86-40.04-12.7-81.05-19.53-121.09l-4.89-27.34c-.97-4.89.0-6.84 4.89-7.82 27.34-4.88 53.71-9.76 85.93-8.79zm982.43 393.56c24.41.0 27.34.98 31.25 24.41 4.88 29.3 8.79 58.6 11.72 87.89l10.74 94.73 20.51 201.17c.97 4.89.0 6.84-4.89 6.84l-76.17 8.79c-7.81.97-9.77.0-10.74-7.81l-43.95-224.61-27.34-149.42-3.91-20.51c-.97-3.9.98-6.83 4.89-7.81 30.27-6.83 59.57-11.72 87.89-13.67zm-1110.36.0c26.37-.98 29.3 1.95 32.23 26.37 6.84 40.04 11.72 79.1 15.63 119.14l12.69 117.18 7.81 79.11 6.84 63.47c0 8.79-.98 10.75-8.79 11.72l-72.26 6.84c-7.82.97-9.77.0-10.75-7.81l-59.57-306.65-15.62-86.91c-.98-4.88.97-7.81 5.86-8.79 30.27-6.83 58.59-11.72 85.93-13.67zm373.05 302.73v125c.98 5.86-1.95 8.79-7.81 7.82h-23.44c-16.6.0-33.2.97-49.8 1.95-8.79.98-9.77.98-10.75-9.77l-15.62-175.78-7.81-86.91-11.72-132.81c-.98-10.75.98-12.7 9.76-13.68 27.35-2.93 54.69-2.93 82.04-1.95l20.5 2.93c7.82 2.93 8.79 3.91 8.79 11.72l2.93 52.73.98 58.6c.98 53.71 1.95 106.44 1.95 160.15zm1108.4 5.86v120.12c0 4.88-1.95 7.81-6.84 6.84h-35.15c-13.67.0-27.35.97-40.04 1.95-7.81.98-8.79.0-9.77-8.79l-20.5-228.52-10.75-113.28-3.9-57.61c-.98-7.82.97-9.77 8.79-9.77 32.22-3.91 65.43-4.88 97.65-.98 12.7.98 14.65 4.89 15.63 17.58l2.93 129.88zm-399.41-516.6c9.76.0 18.55.98 25.39 1.95 4.88.98 6.83 2.93 7.81 7.82l12.69 135.74c2.93 11.72.98 13.67-10.74 13.67l-33.2 1.95c-6.84.98-9.77 1.96-9.77-8.78l-13.67-110.36-3.9-31.25c-.98-5.86.97-8.79 6.83-9.76zm-1106.45.0c7.81.0 15.63.98 22.46 1.95 3.91.98 5.86 2.93 6.84 7.82l3.9 34.18 9.77 106.44c.98 7.81.98 8.79-6.84 8.79l-38.08 1.95c-7.81.98-8.79.0-9.77-7.81l-8.79-78.12-7.81-65.43c-.98-4.89.98-7.82 5.86-7.82 6.84-.97 14.65-1.95 22.46-1.95zm389.65 97.66v67.38c.98 10.74-.98 10.74-9.77 10.74-12.69.0-24.41-.97-36.13-1.95-7.81-.98-8.79-.98-7.81-8.79l-2.93-83.01c0-18.55.0-37.11-.98-55.66-.97-8.79.0-9.77 8.79-9.77 13.67.0 27.34.98 41.02 2.93 7.81.0 7.81 1.96 7.81 9.77zm1109.37.97v67.39c0 8.79-.97 9.76-9.76 9.76l-37.11-1.95c-5.86-.98-8.79-3.91-7.81-8.79l-2.93-139.65c0-7.81.97-8.79 8.79-8.79 12.69.0 24.41.98 36.13 1.96 14.65.97 12.69 3.9 12.69 14.64zM650.73 449.46c.97 11.72.0 13.67-11.72 14.65l-23.44 5.86c-7.81 2.93-8.79.97-9.76-5.86l-24.42-137.7c-2.93-8.79-.98-10.74 7.81-11.72l34.18-5.86c7.82-.97 9.77-.97 9.77 6.84 2.93 16.6 5.86 33.2 7.81 49.8l9.77 78.13zm1039.06-133.79c14.65-2.93 30.27-4.88 45.9-6.84 4.88-.97 6.83 1.96 7.81 6.84l7.81 53.71c3.91 26.37 6.84 52.73 7.82 79.1v7.81c.97 3.91-.98 6.84-4.89 7.82l-31.25 6.83c-4.88.98-6.83-.97-7.81-5.86l-25.39-145.5zM996.43 421.14c0 15.62-.98 30.27-1.95 43.94.0 4.89-1.96 6.84-6.84 7.82l-30.27 2.93c-4.88.97-6.84-1.96-6.84-6.84-1.95-14.65-2.93-28.32-3.9-42.97-1.96-26.37-3.91-53.71-4.89-81.05l-1.95-19.53c-.98-3.91.98-5.86 4.88-5.86l40.04-2.93c6.84.0 8.79.97 8.79 8.79zm1107.42-15.63c.98 18.56.98 38.09.0 56.64.98 8.79-.97 10.75-9.76 10.75l-27.35 2.93c-4.88.97-7.81-1.96-7.81-6.84-.98-24.41-2.93-49.8-4.88-74.22l-3.91-68.36c-.98-4.88.98-6.83 4.88-6.83l39.07-2.93c6.83.0 7.81.97 7.81 8.79 1.95 26.36 2.93 53.71 1.95 80.07zM612.64 738.52c15.63 18.56 18.56 39.06 11.72 61.52-5.86 21.49-16.6 40.04-32.23 55.67-25.39 26.37-54.68 47.85-86.91 64.45-55.66 29.3-113.28 49.81-174.81 60.55-43.94 8.79-87.89 14.65-131.83 17.58-13.67.97-27.34.97-41.02.97h-29.29c-7.82.0-9.77-1.95-10.75-9.76l-6.83-94.73-18.56-186.52-20.5-177.74-11.72-94.72-12.7-90.82c-6.83-49.81-15.62-99.61-24.41-149.42-6.84-40.04-13.67-80.08-22.46-120.11-.98-4.89.0-8.79 4.88-9.77l135.74-56.64c8.79-3.91 16.6-6.84 25.39-8.79 5.86-.98 8.79.98 7.81 6.84.0 15.62.0 31.25-.97 47.85l-.98 12.69c-.97 56.64-.97 113.28.0 170.9.98 49.81 3.91 100.59 6.84 150.39 4.88 78.13 12.69 156.25 20.51 233.4.0 7.81.97 7.81 9.76 6.84 16.6-2.93 32.23-3.91 48.83-3.91 51.76.0 103.51 5.86 153.32 18.55 43.94 10.75 85.94 25.4 127.93 43.95 20.51 9.77 39.06 21.48 56.64 35.16 6.84 4.88 11.72 9.76 16.6 15.62zm1100.59-8.79c20.51 16.6 27.34 39.06 21.48 65.43-4.88 21.49-14.65 40.04-29.3 56.64-23.43 26.37-50.78 46.88-81.05 63.48-58.59 32.23-121.09 54.69-187.5 66.41-36.13 6.83-72.27 12.69-108.4 15.62-20.51 1.95-42.97 2.93-65.43 1.95h-26.37c-5.85.98-8.78-1.95-8.78-7.81-1.96-27.34-3.91-54.69-6.84-82.03l-15.63-166.99-16.6-145.51-20.5-164.06c-2.93-28.32-6.84-57.62-11.72-85.94l-17.58-109.38c-7.81-51.75-17.58-103.51-28.32-155.27l-.98-6.83c-1.95-4.89.0-8.79 4.88-9.77 47.86-19.53 94.73-41.02 142.58-59.57 12.7-4.88 28.32-10.74 27.35.98-3.91 36.13-2.93 72.26-3.91 107.42-.98 29.29-.98 58.59.98 86.91v22.46c0 35.16.97 70.32 3.9 104.49 1.96 45.9 4.89 92.78 8.79 138.68l8.79 98.63c.98 18.55 2.93 36.13 5.86 54.69.0 10.74 1.95 9.76 10.74 8.79 17.58-2.93 35.16-3.91 52.74-3.91 61.52.98 121.09 10.74 179.68 27.34 40.04 10.75 78.13 25.39 115.24 44.93 16.6 8.78 31.25 19.53 45.9 32.22zM301.12 901.61c14.65-8.79 40.04-26.37 75.19-53.71 35.16-28.32 56.64-46.88 65.43-56.64-52.73-23.44-107.42-43.95-164.06-62.5zm1247.07-105.47c2.93-2.93 1.95-4.88-.98-6.84l-23.44-9.76c-41.01-17.58-82.03-33.21-124.02-46.88l-5.86-1.95c-1.95-.98-3.9.0-6.83.98l23.43 168.94c2.93.0 4.89-.98 5.86-1.95 38.09-27.35 76.17-55.67 114.26-85.94z" fill="#07a3d7"/></svg></a></li><li><a href=https://www.zhihu.com/people/he-bo-hang-88 target=_blank title=Zhihu rel=me><svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="m30.628906 8.9882812c-.365625.0421875-.929687.2109376-.929687.2109376s-8.19961.9000002-11.59961 1.0000002c.1.5.400782.9.800782 1 .7.1 1.2.0 2.5.0 1.2-.1 2.198828-.09961 2.798828-.09961V16H18s.099219 1.199219 1.199219 1.199219h5v3.40039c0 .7-.499219 1.09961-1.199219 1.09961s-1.2-.09961-2-.09961c.1.2.200391.69961.900391 1.09961.5.2.798828.300781 1.298828.300781 1.5.0 2.300781-.900781 2.300781-2.300781v-3.5h6.099609c.4.0.400782-1.19961.300782-1.09961h-6.5v-4.90039c.2.0.599609-.09961 1.099609-.09961 2.1-.1 3.500391-.40039 4.400391-.40039.0.0.6-1.399219.0-1.699219-.05-.025-.14961-.0257812-.271485-.0117188zM3.3007812 9c1e-7.0-1.2015624-3906e-7-1.6015624 1.099609-.1000001.4-.7992188 2.000782-1.6992188 3.800782.3.0 1.2007812-.09961 1.8007812-1.09961.1000001-.3.4-.50039.5-.90039h1.5c1e-7.5-.1015624 3.60039-.1015624 3.90039H1.0996094c-.60000003.0-.79882815 1.199219-.79882815 1.199219H3.5c-.2 2.4-1.4 4.100781-3.5 5.800781 1 .3 1.9996094-39e-5 2.5996094-.40039.0.0 1.2007812-.900782 1.8007812-3.300782l2.5 2.900391s.4003906-1.4-.0996094-2c-.3999999-.5-1.2011718-1.400781-1.7011718-1.800781l-.6992188.601562c.2-.7.4003906-1.100781.4003906-1.800781H8s-3906e-7-1.199219-.4003906-1.199219H4.9003906c.1-1.3.0996094-2.80039.0996094-3.90039h2.4003906S7.5 10.800781 7 10.800781H2.5996094c.2-.7.4011719-1.100781.7011718-1.800781zM9 11v11h1.199219l.40039 1.300781L12.699219 22H15V11zm20.287109 1.177734c-.16875.009375-.336328.072657-.486328.222657L27 14.800781 28 15.5c1.1-1.3 2.300781-2.900391 2.300781-2.900391s-.507422-.45-1.013672-.421875zm-19.08789.021485h3.5v8.601562H12.5l-1.400391.898438-.298828-.898438h-.601562zm9.929687.148437c-.421875-.028125-.929687.251953-.929687.251953S21.200781 15.4 21.300781 15.5l1-.699219S21 13 20.5 12.5c-.1-.1-.230469-.142969-.371094-.152344z"/></svg></a></li><li><a href=https://stackoverflow.com/users/16221995/max-he target=_blank title=Stackoverflow rel=me><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M28.16 32H2.475V20.58H5.32v8.575h19.956V20.58h2.884z" fill="#bcbbbb"/><path d="M8.477 19.8l13.993 2.923.585-2.806-13.993-2.923zm1.832-6.704 12.94 6.04 1.208-2.572-12.94-6.08zm3.586-6.353 10.99 9.12 1.832-2.183-10.99-9.12zM20.99.0l-2.3 1.715 8.536 11.46 2.3-1.715zM8.166 26.27H22.43v-2.845H8.166v2.845z" fill="#f48024"/></svg></a></li><li><a href=https://twitter.com/hebohang1 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/photos/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>相册</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/%E9%93%BE%E6%8E%A5/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>链接</span></a></li><li><a href=/hengine/><!doctype html><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32" enable-background="new 0 0 32 32"><image id="image0" width="32" height="32" x="0" y="0" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJN AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACzVBMVEUAAAADAwMEBAQEBAUC AwMoKisdHh80NjgODg8DAwQGAwQIBAUAAAAAAAAUFRUSExMAAAAAAAAAAAAAAAAODw8QEREAAAAA AAAAAAANDQ5YXWBTWFsICQkAAAAFBQZNUlVbYGQLDAwAAABJTU9BRUgAAAA6PkFNUVUAAAAAAABq cHUAAAAAAABmbHAAAABudXoAAABrcXYBAQFudXlqcXYAAAAcHh+MlJgTFBWGjpInKSqTm6AICAh8 g4dudXoAAAAAAABsc3gAAAAAAAAAAAAAAABob3NVWl5YXWFYXWEFBgZEREdsc3hrcndqcXUICQkp ExYAAAAAAAAAAABpcHQHCAgiERMAAAACAgNXLTIAAABbLjQAAABbLzRQKjAgDxICAQFjaWxkaWxk aWxgZWgAAABnbnIAAABJTE86PT8AAABBRUhUWV1YXV9NUlQHBwgJCgpaYGRobnMREhMAAAATFBUA AAAZGhsbHR4CAgKUnKGSmZ6Zo6meqK63wce/yc/BzNLAzNTT4OnS4OnJ1d5xd3u/ytC8xszAytHR 3ebS3+jP3OV8g4l1e3/BzNPR3ueBiY50en2/ydDCzdSAiI6+yM7DztW+yc90en7Q3ea+yM/O2+OY oqmWn6a9x83K1t7J1d2bpKl8hIiQmp/F0trQ3ueuusKJlJqUn6XBztZ2fH9JMTZvO0NbNDtXVVp0 fIFSOT59QUlsO0FTTVG1wclRV1lNNDm+YnHXcIHSbX6NSVJgMjjUa3j1fYvye4mVS1Shq7IwNDV2 QEnTbn/ec4PseIbyfIrxe4nzfIrZb3s9QkRkOEDXcIDteYjDZG9obnJPSk2MSFPUb4DjdYTdcX52 fIClr7RHQEONSVTYcIHwe4l1e36irLFGQEPWcIHPa3mKR1O2X22jrLI9Oj3AytB9hYqxusDDz9jS 3+nL2OGUnKCQmJ2kr7aos7r///9Bp/WSAAAAenRSTlMAAAAAAAAAAAAAAAAMabSvXAcIZLq/dA8G ivn0dgJ59vuSO/DkKOTyPWP6Skf5Z/tO+Wf6+WZN9lP5R/Rf/fpMSPtyMDRv+vTv8Gf++vr7Z9dU S3/7Z64BZ+9P8GXw8NFc+/r7+kb4YvDjJeHw+fR1cvP5imi0Wq60adzIANYAAAABYktHRO7Pt9I3 AAAAB3RJTUUH5wsRCzUM/zLhDQAAAeZJREFUOMtjYAABHl4+fgFBBjgQEhYRFRNH8CUkpaqqpWVk YXxZOfmaWgVFhA4l5br6hkYVVRhfVa2xqblFXQPGZ9RsbWvv6NTShgno6HZ1dzf1aDJC+Ux6vfXt ff36BjAF2oYgBROMmKF8Fr2Jk9ondxkjFJiAFEwxhSlgNTOf2j4NjwI2C8vpeBWwW1njN4HDxrYe rxs49WaAfGFnD1PggKYA7M2OmY5Ozi5g4OzqhkXBrNlz3D08wcDDfW4/poJ582d2wwGIiapg0tT6 BTO7+5u7EKpQFUxfuGjxkqXLlq9Y2Y9NgdGMVavXrF23fsPGTZu3NHV1dfWjKfDaum37jp27du/Z u2+/t4+vr98BNEf6Hzy04/DhI0ePHT9xMiAwyCE4BM2boadOHz58+MzZ48f3ngsLB6YH9ICKOH/h 4qXDhy8fP3ElMooLM6iZ9K5eu37j0uGbt65Ex4QzYFNwu+HO3RuX7t2PBctjUdBbP/XO9QcP4yDy WBW0T330OD4hnAG3gvYniYHcDPgU1CfhTDBMRmAFyWgKEMkenHHa61PgGSc1DaTgaTos4zAoZdTV 1z/LhGe9rOznL7pe5ijB86aEZO6r13n54TB+eEHhm7dFxRJwBQw8JaUo2V+irLyikgfMBAAjrRDp zyCqmwAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMy0xMS0xN1QxMTo1MzoxMiswMDowMHzyfZ8AAAAl dEVYdGRhdGU6bW9kaWZ5ADIwMjMtMTEtMTdUMTE6NTM6MTIrMDA6MDANr8UjAAAAKHRFWHRkYXRl OnRpbWVzdGFtcAAyMDIzLTExLTE3VDExOjUzOjEyKzAwOjAwWrrk/AAAAABJRU5ErkJggg=="/></svg>
<span>HEngine</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://hebohang.github.io/ selected></option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#概览>概览</a></li><li><a href=#gridlevelcell-的划分>Grid、Level、Cell 的划分</a><ol><li><a href=#wp-与-uworldulevel-的串连>WP 与 UWorld、ULevel 的串连</a></li><li><a href=#uworldpartition>UWorldPartition</a></li><li><a href=#gridlevelcell-的基础含义>Grid、Level、Cell 的基础含义</a></li><li><a href=#初始化generatestreaming>初始化：GenerateStreaming</a><ol><li><a href=#actor-的划分--归属于哪一级-level-的哪一个-cell>Actor 的划分 —— 归属于哪一级 Level 的哪一个 Cell</a></li><li><a href=#getpartitionedactors>GetPartitionedActors</a></li></ol></li><li><a href=#运行时level-streaming-的加载>运行时：Level Streaming 的加载</a></li></ol></li><li><a href=#ofpa>OFPA</a><ol><li><a href=#__externalactors__-与-__externalobjects__><strong>ExternalActors</strong> 与 <strong>ExternalObjects</strong></a></li><li><a href=#编辑器下actor的加载>编辑器下Actor的加载</a></li><li><a href=#引用关系>引用关系</a></li></ol></li><li><a href=#debug>Debug</a><ol><li><a href=#demp大世界场景信息>Demp大世界场景信息</a></li><li><a href=#grid调试>Grid调试</a></li><li><a href=#获取ofpa的actor的信息>获取OFPA的Actor的信息</a></li></ol></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/ue5/>UE5</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/worldpartition%E8%A7%A3%E6%9E%90/>WorldPartition解析</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 08, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 8 分钟</time></div></footer></div></header><section class=article-content><h2 id=概览>概览</h2><p>在 UE5 推出了服务于大世界的 World Partition 系统，总的来说主要分几大块：</p><ol><li>Grid、Level（Grid Level，非 ULevel）、Cell 的划分</li><li>OFPA</li><li>Level Instance</li><li>Data Layer</li><li>HLOD</li></ol><p>还有一些也与之相关，例如之前研究过的 LandscapeSpline 也在 WP 版本有特殊的实现方式。</p><p><a class=link href=https://docs.unrealengine.com/5.3/zh-CN/world-partition-in-unreal-engine/ target=_blank rel=noopener>https://docs.unrealengine.com/5.3/zh-CN/world-partition-in-unreal-engine/</a></p><p>以下代码均为 5.3 版本对应代码。</p><h2 id=gridlevelcell-的划分>Grid、Level、Cell 的划分</h2><h3 id=wp-与-uworldulevel-的串连>WP 与 UWorld、ULevel 的串连</h3><p>我们知道，UE中，一个 UWorld 由各个 ULevel 组织而成，每个 ULevel 则拥有一个对应的设置信息记录 AWorldSettings：
<a class=link href=https://zhuanlan.zhihu.com/p/22924838 target=_blank rel=noopener>https://zhuanlan.zhihu.com/p/22924838</a></p><p>AWorldSettings 对应编辑器中的 World Settings 面板，也是保存 UWorldPartition 的容器：
<img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image.png width=709 height=365 loading=lazy class=gallery-image data-flex-grow=194 data-flex-basis=466px></p><p>这里使用的是 UE5 新增的 TObjectPtr，方便序列化反序列化，可参考：
<a class=link href=https://zhuanlan.zhihu.com/p/504115127 target=_blank rel=noopener>https://zhuanlan.zhihu.com/p/504115127</a></p><p>我们在编辑器新打开一个 World Partition 地图的时候（File->New Level->Open World），会调用 <code>FEditorFileUtils::LoadMap(*MapPackageFilename, /*bLoadAsTemplate=*/true);</code>
去加载一个大世界模板地图，接着加载 AWorldSettings 的时候就会把对应 WorldPartition 随之加载进来。</p><p>当然，既然是 UObject 我们也可以直接 <code>NewObject&lt;UWorldPartition>(WorldSettings);</code></p><p>在 UWorld、ULevel 中则均有 GetWorldPartition 方法，实现均是拿到对应 WorldSettings（UWorld 则是拿对应 PersistentLevel 的 WorldSettings）的 WorldPartition：
<img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-1.png width=922 height=367 loading=lazy class=gallery-image data-flex-grow=251 data-flex-basis=602px></p><p>对于 UWorld 我们也有 IsPartitionedWorld 方法来判断是否是 WP 版本：
<code>bool IsPartitionedWorld() const { return GetWorldPartition() != nullptr; }</code></p><p>因此我们可以这样写：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>Actor</span><span class=o>-&gt;</span><span class=n>GetWorld</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>Actor</span><span class=o>-&gt;</span><span class=n>GetWorld</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>IsPartitionedWorld</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=uworldpartition>UWorldPartition</h3><p>既然 WP 是保存在 AWorldSettings 中，编辑器下我们就可以调整对应设置：
<img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-2.png width=720 height=939 loading=lazy class=gallery-image data-flex-grow=76 data-flex-basis=184px></p><p>引擎为其定制了此面板，可参考：Engine\Source\Editor\WorldPartitionEditor\Private\WorldPartition\Customizations\WorldPartitionDetailsCustomization.h</p><p>有几处设置需要细讲，我们先回到 UWorldPartition 这个类，他本身继承自 UObject、FActorDescContainerCollection、IWorldPartitionCookPackageGenerator，
也就是说他本身就存放有所有的 ActorDesc，在 UActorDescContainer 的 ActorsByName 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>using</span> <span class=n>FNameActorDescMap</span> <span class=o>=</span> <span class=n>TMap</span><span class=o>&lt;</span><span class=n>FName</span><span class=p>,</span> <span class=n>TUniquePtr</span><span class=o>&lt;</span><span class=n>FWorldPartitionActorDesc</span><span class=o>&gt;*&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>FNameActorDescMap</span> <span class=n>ActorsByName</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的 ActorDesc 即 FWorldPartitionActorDesc 类型十分重要，他保存有 Guid、ActorPackage、ActorPath 等离线信息（即保存在资产中的信息）以及
AActor的指针 ActorPtr、引用计数等运行时信息（即运行游戏才有的信息）。为后续划分所属 Cell（GenerateStreaming）等功能服务。</p><p>我们可以用 <code>wp.Editor.DumpActorDescs hbh_test.csv</code> 指令把他们都 dump 出来，参数是文件路径。</p><p>接着回到编辑器面板，对应 UWorldPartition 的：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-3.png width=1377 height=376 loading=lazy class=gallery-image data-flex-grow=366 data-flex-basis=878px></p><p>我们的 RuntimeHash 除非特殊需要自己定制，否则都是走默认的 UWorldPartitionRuntimeSpatialHash，在World Settings中可以修改，
那么接下来的 Preview Grids 以及 Grids 与 Debug Color 等设置则都属于 UWorldPartitionRuntimeSpatialHash：
<img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-4.png width=674 height=276 loading=lazy class=gallery-image data-flex-grow=244 data-flex-basis=586px></p><p>可以看到他们都被 WITH_EDITORONLY_DATA 包裹，真正运行游戏时，最重要的 Cell Size、Loading Range 等信息会被重新安置给 StreamingGrids：
<img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-5.png width=698 height=190 loading=lazy class=gallery-image data-flex-grow=367 data-flex-basis=881px></p><p>而这一过程则是在最重要的 GenerateStreaming 函数中完成的：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-6.png width=1698 height=407 loading=lazy class=gallery-image data-flex-grow=417 data-flex-basis=1001px></p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-7.png width=1104 height=236 loading=lazy class=gallery-image data-flex-grow=467 data-flex-basis=1122px></p><h3 id=gridlevelcell-的基础含义>Grid、Level、Cell 的基础含义</h3><p>在进入正式分析之前，再简单说一下这三个的意思。</p><p>Grid 是棋盘，Cell 是格子，Level 则是分层管理。每一级 Level 都有自己的格子，即自己的 Cell Size，每两级 Level 之间的 Cell Size 是乘 2 的关系，
即格子放大四倍（宽、高都乘上了2）。</p><p>Level 0 的 Cell Size 是 WP 面板上填的数值，也是最小的 Cell Size，最大的一级 Level 则会覆盖整个世界，因此我们只需要知道 Level 的
总个数以及面板上自己设定的 Cell Size，就知道了每一级 Level 的 Cell Size，具体函数如下（会在 UWorldPartitionRuntimeSpatialHash 的 GenerateStreaming 函数中调用，后面章节会详细分析）：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-19.png width=1067 height=440 loading=lazy class=gallery-image data-flex-grow=242 data-flex-basis=582px></p><p>一个例子如下：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-20.png width=631 height=181 loading=lazy class=gallery-image data-flex-grow=348 data-flex-basis=836px></p><p>显然为了内存考虑，一个 Level 只会保存含有 Actor 的那些格子，在这个例子中，我们可以看到 Level 0 有 7 个 Cell，Level 4 则有 25 个；一个 Actor 只会被划分到固定一级 Level 的固定一个 Cell 中。</p><h3 id=初始化generatestreaming>初始化：GenerateStreaming</h3><p>这是 WP 最重要的函数之一，在 UWorldPartition::OnBeginPlay 中我们会调用此函数，来完成对所有 Actor 的划分，决定归属于哪一级 Level 的哪一个 Cell 中，以及
哪些 Actor 会打到一个 Cluster 里面（根据引用关系来）。这样划分好后，我们加载的时候，就只需要根据 Loading Range 来判断覆盖了哪些 Cell，然后去 SpatialHash 中拿到
加载对应 Cell 中的 Actor 所在的 Cluster. 例如 A 引用了 B，而此时 A 所处的 Cell 被覆盖，而 B 所处的 Cell 未被覆盖，那么加载 A 时，由于有引用关系，我们也会把 B 给加载出来，
对于 B 所处 Cell 的其他 Actor 则不予理会。</p><p>我们会调用到 UWorldPartition::GenerateContainerStreaming 中，此时分为三步：</p><ol><li><p>Dump state log</p><p>这一步我们会把WP相关信息都dump出来，和指令 <code>wp.Editor.DumpStreamingGenerationLog</code> 是一样的效果，我们放在后面的 Debug 一节重点讲。当然这一步是做好 dump 的准备工作，在后面的2、3都会执行相关dump操作。</p></li><li><p>Preparation Phase</p><p>这一步我们会创建所有的 Container，这里的 Container 即 UActorDescContainer，我们会递归完善所有的 ActorDesc 信息、ActorDescView 信息、Cluster 信息，
打进 Cluster 的相关算法都在 GenerateObjectsClusters 函数中：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-10.png width=1853 height=183 loading=lazy class=gallery-image data-flex-grow=1012 data-flex-basis=2430px></p></li><li><p>Generate streaming</p><p>这一步首先我们会创建 Streaming 所需的 Policy，然后根据 Policy 去完成 Actor 的划分（归属于哪一级 Level 的哪一个 Cell）。Policy 在代码中写死的为 UWorldPartitionStreamingPolicy。</p></li></ol><h4 id=actor-的划分--归属于哪一级-level-的哪一个-cell>Actor 的划分 —— 归属于哪一级 Level 的哪一个 Cell</h4><p>我们重点来看最后这步：根据 Policy 去完成 Actor 的划分。我们最终会调用到 UWorldPartitionRuntimeSpatialHash 的 GenerateStreaming 函数（如果是默认的 UWorldPartitionRuntimeSpatialHash 的话）：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-12.png width=1623 height=154 loading=lazy class=gallery-image data-flex-grow=1053 data-flex-basis=2529px></p><p>在进入 UWorldPartitionRuntimeSpatialHash 的 GenerateStreaming 函数之前，我们首先需要看上图圈出来的 GetStreamingGenerationContext 函数，这一步我们会创建出一个 FStreamingGenerationContext，
在里面我们会把 Preparation Phase 创立的 Cluster 给写到 ActorSetInstances 中，具体可看 FStreamingGenerationContext 的构造函数。</p><p>接着进入 UWorldPartitionRuntimeSpatialHash 的 GenerateStreaming 函数，这里我们会根据 Policy 以及刚刚创立的 StreamingGenerationContext 完成最终 Actor 的划分。大体上又分几个步骤：</p><ol><li><p>提取面板设置的 Grid 信息</p><p>首先是 UWorldPartition 一节所述，会先提取面板设置的 Grid 信息</p></li><li><p>把 ActorSetInstance 写到中间变量 GridActorSetInstances 中</p><p>这一步即包含我们的 Cluster 信息。</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-11.png width=1394 height=266 loading=lazy class=gallery-image data-flex-grow=524 data-flex-basis=1257px></p></li><li><p>根据 WP 面板设置，完成 Actor 的划分</p><p>重点看 RuntimeSpatialHashGridHelper.cpp 中的 GetPartitionedActors 函数，接下来会详细分析。</p></li><li><p>完成最终 FSpatialHashStreamingGrid 的构建</p><p>对应 CreateStreamingGrid 函数。至此初始化完毕。</p></li></ol><h4 id=getpartitionedactors>GetPartitionedActors</h4><p>在这里我们又会分几步进行：</p><p>3.1. FSquare2DGridHelper</p><p>关键点是这几个配置：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-13.png width=485 height=118 loading=lazy class=gallery-image data-flex-grow=411 data-flex-basis=986px></p><p>这是 5.3 才给出的选项，前两个一般勾选 Disabled ，是为了解决老版本的问题：</p><p>这里保存 Cell 的时候也是仅考虑上面有 Actor 的情形，我们也可以手动调用这个函数来完成一些事情，例如调查有几个 Cell 的小工具：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>UWorldPartition</span><span class=o>*</span> <span class=n>WorldPartition</span> <span class=o>=</span> <span class=n>WorldSettings</span><span class=o>-&gt;</span><span class=n>GetWorldPartition</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>UWorldPartition</span><span class=o>::</span><span class=n>FGenerateStreamingParams</span> <span class=n>Params</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UWorldPartition</span><span class=o>::</span><span class=n>FGenerateStreamingContext</span> <span class=n>Context</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>WorldPartition</span><span class=o>-&gt;</span><span class=n>GenerateStreaming</span><span class=p>(</span><span class=n>Params</span><span class=p>,</span> <span class=n>Context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>UWorldPartitionRuntimeHash</span><span class=o>*</span> <span class=n>RuntimeHash</span> <span class=o>=</span> <span class=n>WorldPartition</span><span class=o>-&gt;</span><span class=n>RuntimeHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>nullptr</span> <span class=o>==</span> <span class=n>RuntimeHash</span><span class=p>)</span> <span class=p>{</span> <span class=k>continue</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>UWorldPartitionRuntimeSpatialHash</span><span class=o>*</span> <span class=n>RuntimeSpatialHash</span> <span class=o>=</span> <span class=n>Cast</span><span class=o>&lt;</span><span class=n>UWorldPartitionRuntimeSpatialHash</span><span class=o>&gt;</span><span class=p>(</span><span class=n>RuntimeHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>nullptr</span> <span class=o>==</span> <span class=n>RuntimeSpatialHash</span><span class=p>)</span> <span class=p>{</span> <span class=k>continue</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>int32</span> <span class=n>CellNum</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>int32</span> <span class=n>TotalActorsCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>RuntimeSpatialHash</span><span class=o>-&gt;</span><span class=n>ForEachStreamingCells</span><span class=p>([</span><span class=o>&amp;</span><span class=p>](</span><span class=k>const</span> <span class=n>UWorldPartitionRuntimeCell</span><span class=o>*</span> <span class=n>RuntimeCell</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>CellNum</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>TotalActorsCount</span> <span class=o>+=</span> <span class=n>RuntimeCell</span><span class=o>-&gt;</span><span class=n>GetActorCount</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的 ForEachStreamingCells 方法返回 false 的时候会直接阻断，只有返回 true 的时候才会继续遍历下一个 Cell。</p><h3 id=运行时level-streaming-的加载>运行时：Level Streaming 的加载</h3><p>我们的加载主要是通过 UWorldPartitionLevelStreamingDynamic 完成，他本身就继承自 ULevelStreamingDynamic：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-14.png width=722 height=53 loading=lazy class=gallery-image data-flex-grow=1362 data-flex-basis=3269px></p><p>我们在运行时会更新 World 中的各个 Subsystem，调用 UpdateStreamingState：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-16.png width=1215 height=388 loading=lazy class=gallery-image data-flex-grow=313 data-flex-basis=751px></p><p>其中和 WP 相关的主要是 UWorldPartitionSubsystem，在他的 UpdateStreamingState 函数中，我们会根据 StreamingPolicy 拿到当前需要加载的 Cell，
再通过 UWorldPartitionStreamingPolicy::SetCellStateToActivated 函数去 Load 这些 Cell：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-17.png width=908 height=227 loading=lazy class=gallery-image data-flex-grow=400 data-flex-basis=960px></p><p>这里每个 Cell 会对应一个 UWorldPartitionLevelStreamingDynamic，</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-18.png width=708 height=61 loading=lazy class=gallery-image data-flex-grow=1160 data-flex-basis=2785px></p><p>因而加载的时候也是最终调用到 UWorldPartitionLevelStreamingDynamic::Activate</p><h2 id=ofpa>OFPA</h2><h3 id=__externalactors__-与-__externalobjects__><strong>ExternalActors</strong> 与 <strong>ExternalObjects</strong></h3><p>对于 <strong>ExternalObjects</strong>，他主要保存的是 Outliner 的文件夹对象，对应 UE 的 UActorFolder 类。</p><p>对于 <strong>ExternalActors</strong>，他保存的是关卡中的Actor对象，实际上会对Actor调用 SetPackageExternal(true)，最后给 Object 设置上 RF_HasExternalPackage 标记：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-21.png width=1215 height=320 loading=lazy class=gallery-image data-flex-grow=379 data-flex-basis=911px></p><p>而在序列化时，我们保存的是 UPackage，对于标记了 RF_HasExternalPackage 的 Actor，他的 GetPackage 方法最终会得到 ExternalPackage：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-24.png width=615 height=225 loading=lazy class=gallery-image data-flex-grow=273 data-flex-basis=656px></p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-23.png width=929 height=241 loading=lazy class=gallery-image data-flex-grow=385 data-flex-basis=925px></p><p>这段代码的逻辑是，我们会不断拿 ExternalPackage，如果 OuterPrivate 非空且标记了 RF_HasExternalPackage，就会拿到一份 ExternalPackage，如果 OuterPrivate 非空但没标记上 RF_HasExternalPackage，拿到的就是 nullptr；
而如果拿到 nullptr，则会继续追踪 Outer（OuterPrivate），直到没有 Outer，表示到达最顶层，从而拿到最顶层 UPackage</p><p>在 FPackagePath 类中有方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>const</span> <span class=n>TCHAR</span><span class=o>*</span> <span class=n>FPackagePath</span><span class=o>::</span><span class=n>GetExternalActorsFolderName</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>TEXT</span><span class=p>(</span><span class=s>&#34;__ExternalActors__&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>TCHAR</span><span class=o>*</span> <span class=n>FPackagePath</span><span class=o>::</span><span class=n>GetExternalObjectsFolderName</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>TEXT</span><span class=p>(</span><span class=s>&#34;__ExternalObjects__&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=编辑器下actor的加载>编辑器下Actor的加载</h3><p>对于 <strong>ExternalObjects</strong>，会在 ULevel::PostLoad 中调用 FExternalPackageHelper::LoadObjectsFromExternalPackages 来加载：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-25.png width=1016 height=213 loading=lazy class=gallery-image data-flex-grow=476 data-flex-basis=1144px></p><p>实际上也就是根据 Level 名字拿到对应 __ExternalObjects__ 路径。例如 Content/HbhTest/NewMap.umap 就会拿到 Content/__ExternalObjects__/HbhTest/NewMap 这个路径从而直接加载里头的所有 Package：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-26.png width=1215 height=308 loading=lazy class=gallery-image data-flex-grow=394 data-flex-basis=946px></p><p>对于 <strong>ExternalActors</strong> 也类似，只是挪到了 ULevel::OnLevelLoaded 里面初始化 WorldPartition 的阶段，最后会调用到 UActorDescContainer::Initialize 来加载所有对应 __ExternalActors__ 路径下的 Actor：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-22.png width=1395 height=546 loading=lazy class=gallery-image data-flex-grow=255 data-flex-basis=613px></p><p>这些 Actor 信息在编辑器情况下最后会被缓存到 WorldPartition 的 EditorHash 中，最后可以根据 XYZ 以及对应 Level 级别得到所有的 Actor：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-27.png width=803 height=137 loading=lazy class=gallery-image data-flex-grow=586 data-flex-basis=1406px></p><h3 id=引用关系>引用关系</h3><p>在前一节中我们说过，加载的时候是根据路径来判断的，Map 对应的资产并不会存有 __ExternalObjects__ 与 __ExternalActors__ 的信息。但是当我们使用 Reference Viewer 进行查看的
时候，会发现大世界 Map 对应的 Dependencies 有所有的 __ExternalActors__，而 Referencers 既有 __ExternalActors__ 又有 __ExternalObjects__</p><p>这是因为 UE 的 Reference Viewer 也对大世界关卡特殊处理了，在打开ue编辑器的时候，他会对所有资产做一个缓存，存到 FAssetRegistryState 的 CachedAssets 中，我们每添加一个依赖，就会对应的
添加上引用：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-29.png width=1112 height=489 loading=lazy class=gallery-image data-flex-grow=227 data-flex-basis=545px></p><p>因此对于一个大世界 map，实际上是对 __ExternalObjects__ 的这些资产添加上了 map 的依赖，从而让 map 的引用有了 __ExternalObjects__ 里的东西。</p><p>而对于 map 本身的依赖项，ue 会进行特殊处理：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-28.png width=1951 height=678 loading=lazy class=gallery-image data-flex-grow=287 data-flex-basis=690px></p><p>和上一节加载的手法类似，从而让 map 的 dependencies 有了这些 __ExternalActors__</p><h2 id=debug>Debug</h2><h3 id=demp大世界场景信息>Demp大世界场景信息</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wp.Editor.DumpStreamingGenerationLog
</span></span></code></pre></td></tr></table></div></div><p>5.3版本可以使用这个命令，输出一次WP的信息（也可以运行一次游戏或者cook的时候），输出结果会在 Saved\Logs\WorldPartition 里。</p><h3 id=grid调试>Grid调试</h3><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-15.png width=1717 height=774 loading=lazy class=gallery-image data-flex-grow=221 data-flex-basis=532px></p><p><a class=link href=https://docs.unrealengine.com/5.3/zh-CN/world-partition-in-unreal-engine/ target=_blank rel=noopener>https://docs.unrealengine.com/5.3/zh-CN/world-partition-in-unreal-engine/</a></p><h3 id=获取ofpa的actor的信息>获取OFPA的Actor的信息</h3><p>右键可以获取对应的本地路径：</p><p><img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-8.png width=716 height=166 loading=lazy class=gallery-image data-flex-grow=431 data-flex-basis=1035px></p><p>想获取guid，我测试下来可以这样做：</p><ol><li>视口点击想确定的actor</li><li>切换到python命令行<img src=/p/worldpartition%E8%A7%A3%E6%9E%90/image-9.png width=685 height=56 loading=lazy class=gallery-image data-flex-grow=1223 data-flex-basis=2935px></li><li>运行指令 <code>print(unreal.get_editor_subsystem(unreal.EditorActorSubsystem).get_selected_level_actors()[0].get_editor_property("actor_guid").to_string())</code></li></ol><h2 id=参考>参考</h2><p><a class=link href=https://zhuanlan.zhihu.com/p/675514420 target=_blank rel=noopener>https://zhuanlan.zhihu.com/p/675514420</a></p><p><a class=link href=https://zhuanlan.zhihu.com/p/610772419 target=_blank rel=noopener>https://zhuanlan.zhihu.com/p/610772419</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/ue5/>UE5</a>
<a href=/tags/ue5-worldpartition/>UE5-WorldPartition</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/worldpartition/><div class=article-details><h2 class=article-title>WorldPartition</h2></div></a></article><article><a href=/p/%E6%9D%82%E9%A1%B9/><div class=article-details><h2 class=article-title>杂项</h2></div></a></article><article><a href=/p/cook/><div class=article-details><h2 class=article-title>Cook</h2></div></a></article><article><a href=/p/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/><div class=article-details><h2 class=article-title>版本控制</h2></div></a></article><article><a href=/p/%E5%9C%BA%E6%99%AF%E4%BC%98%E5%8C%96/><div class=article-details><h2 class=article-title>场景优化</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.0.1/weibo","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq"],locale:{admin:"Admin",placeholder:null},requiredMeta:["name","email","url"],serverURL:"https://hebohang-website-hugo-waline-vercel.vercel.app/"})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 hebohang</section><section class=powerby><br></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>